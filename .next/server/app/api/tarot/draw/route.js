(()=>{var e={};e.id=3539,e.ids=[3539],e.modules={2507:(e,r,t)=>{"use strict";t.d(r,{U:()=>i});var s=t(34386),a=t(44999);async function i(){let e=await (0,a.UL)(),r="https://pqfsbxcbsxuyfgqrxdob.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxZnNieGNic3h1eWZncXJ4ZG9iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NDk4MDAsImV4cCI6MjA2MzUyNTgwMH0.RH_VQLoTOdAauUciYWC39Wto1ZmK28gWjQ9eWJ0FEGU";if(!r||!t){if("phase-production-build"===process.env.NEXT_PHASE)return console.warn("Supabase environment variables not available during build. Using mock client."),null;throw Error("Missing Supabase environment variables. Please check NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY in your .env.local file.")}return(0,s.createServerClient)(r,t,{cookies:{getAll:()=>e.getAll(),setAll(r){try{r.forEach(({name:r,value:t,options:s})=>e.set(r,t,s))}catch{}}}})}},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},39727:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},45167:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>h,routeModule:()=>l,serverHooks:()=>g,workAsyncStorage:()=>p,workUnitAsyncStorage:()=>m});var s={};t.r(s),t.d(s,{POST:()=>d});var a=t(96559),i=t(48088),n=t(37719),o=t(32190),c=t(2507),u=t(86481);async function d(e){let r=Date.now(),t=new u.A("tarot-api");try{let{count:s=1,deckId:a="00000000-0000-0000-0000-000000000001",spread:i="single",allowReversed:n=!0,userId:u}=await e.json();if(!Number.isInteger(s)||s<1||s>10)return o.NextResponse.json({success:!1,error:"Invalid count parameter. Must be between 1 and 10.",code:"INVALID_COUNT"},{status:400});let d=["single","three-card","celtic-cross"];if(!d.includes(i))return o.NextResponse.json({success:!1,error:"Invalid spread type.",code:"INVALID_SPREAD",validSpreads:d},{status:400});let l=await (0,c.U)(),{data:p,error:m}=await l.from("decks").select("*").eq("id",a).eq("is_active",!0).single();if(m||!p)return t.error("deck_fetch_error",u,{deckId:a},m||void 0,"Failed to fetch deck data"),o.NextResponse.json({success:!1,error:"Deck not found or inactive",code:"DECK_NOT_FOUND"},{status:404});let{data:g,error:h}=await l.from("cards").select("*").eq("deck_id",a).order("card_number");if(h||!g||0===g.length)return t.error("cards_fetch_error",u,{deckId:a},h||void 0,"Failed to fetch cards"),o.NextResponse.json({success:!1,error:"No cards found for deck",code:"NO_CARDS"},{status:500});let _={single:1,"three-card":3,"celtic-cross":10}[i]||s;if(g.length<_)return o.NextResponse.json({success:!1,error:`Insufficient cards in deck. Need ${_}, have ${g.length}`,code:"INSUFFICIENT_CARDS"},{status:500});let f=[...g];for(let e=f.length-1;e>0;e--){let r=Math.floor(Math.random()*(e+1));[f[e],f[r]]=[f[r],f[e]]}let x=f.slice(0,_).map((e,r)=>{let t=n&&.3>Math.random();return{id:e.id,name:e.name,suit:e.suit,arcana_type:e.arcana_type,card_number:e.card_number,image_url:e.image_url,meaning_upright:e.meaning_upright,meaning_reversed:e.meaning_reversed,keywords:e.keywords,position:((e,r)=>{let t={single:["Present Situation"],"three-card":["Past","Present","Future"],"celtic-cross":["Present Situation","Challenge/Cross","Distant Past/Foundation","Recent Past","Possible Outcome","Immediate Future","Your Approach","External Influences","Inner Feelings","Final Outcome"]};return(t[e]||t.single)[r]||`Position ${r+1}`})(i,r),isReversed:t,description:e.description||"",elemental_association:e.elemental_association,astrological_association:e.astrological_association}}),v=Date.now()-r,w=`draw_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,I={success:!0,data:{cards:x,metadata:{deckId:a,deckName:p.name,deckDescription:p.description,spreadType:i,drawId:w,timestamp:new Date().toISOString(),cardCount:x.length,allowReversed:n,userId:u||null},performance:{fetchTimeMs:v,cardsFetched:g.length,cardsDrawn:x.length}}};return t.info("tarot_draw_success",u,{spread:i,deckId:a,drawId:w},`Drew ${x.length} cards`),o.NextResponse.json(I,{headers:{"Cache-Control":"no-cache, no-store, must-revalidate","X-Draw-Time":v.toString(),"X-Draw-ID":w}})}catch(e){return t.error("tarot_draw_error",void 0,{},e,"Failed to draw tarot cards."),o.NextResponse.json({success:!1,error:"Internal server error",code:"INTERNAL_ERROR",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}let l=new a.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/tarot/draw/route",pathname:"/api/tarot/draw",filename:"route",bundlePath:"app/api/tarot/draw/route"},resolvedPagePath:"/Users/kfitz/mystic-arcana-v1000/src/app/api/tarot/draw/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:p,workUnitAsyncStorage:m,serverHooks:g}=l;function h(){return(0,n.patchFetch)({workAsyncStorage:p,workUnitAsyncStorage:m})}},47990:()=>{},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},86481:(e,r,t)=>{"use strict";t.d(r,{A:()=>a});class s{constructor(e){this.serviceName=e}log(e,r,t,s,a,i){let n={timestamp:new Date().toISOString(),level:e,service:this.serviceName,action:r,userId:t,metadata:s,message:a};i&&(n.error={name:i.name,message:i.message,stack:i.stack}),console.log(JSON.stringify(n))}debug(e,r,t,s){this.log("DEBUG",e,r,t,s)}info(e,r,t,s){this.log("INFO",e,r,t,s)}warn(e,r,t,s){this.log("WARN",e,r,t,s)}error(e,r,t,s,a){this.log("ERROR",e,r,t,a,s)}}let a=s},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[4447,580,6437,3410],()=>t(45167));module.exports=s})();