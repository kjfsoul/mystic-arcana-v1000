(()=>{var e={};e.id=6644,e.ids=[6644],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},39727:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},50160:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>_,routeModule:()=>m,serverHooks:()=>N,workAsyncStorage:()=>f,workUnitAsyncStorage:()=>h});var s={};r.r(s),r.d(s,{DELETE:()=>x,GET:()=>I});var a=r(96559),i=r(48088),n=r(37719),o=r(66437);let c="https://pqfsbxcbsxuyfgqrxdob.supabase.co",d="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxZnNieGNic3h1eWZncXJ4ZG9iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NDk4MDAsImV4cCI6MjA2MzUyNTgwMH0.RH_VQLoTOdAauUciYWC39Wto1ZmK28gWjQ9eWJ0FEGU";if(!c||!d)throw Error("Missing Supabase environment variables");let u=(0,o.UU)(c,d,{auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0}});var g=r(86481),p=r(32190);let l=new g.A("TarotGetReadingAPI");async function I(e){try{let{searchParams:t}=new URL(e.url),r=(0,o.UU)("https://pqfsbxcbsxuyfgqrxdob.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxZnNieGNic3h1eWZncXJ4ZG9iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NDk4MDAsImV4cCI6MjA2MzUyNTgwMH0.RH_VQLoTOdAauUciYWC39Wto1ZmK28gWjQ9eWJ0FEGU"),{data:{user:s}}=await r.auth.getUser();if(!s)return l.warn("tarot_get_reading_unauthenticated",void 0,void 0,"Attempted to get reading without authentication."),p.NextResponse.json({success:!1,error:"Authentication required",code:"UNAUTHENTICATED"},{status:401});let a=s.id,i=t.get("id"),n=t.get("date"),c=t.get("dateFrom"),d=t.get("dateTo"),u=t.get("spreadType"),g=t.get("tags"),I=t.get("isPublic"),x=Math.max(1,parseInt(t.get("page")||"1")),m=Math.min(100,Math.max(1,parseInt(t.get("limit")||"10"))),f=t.get("sort")||"created_at",h="asc"===t.get("order")?"asc":"desc";if(i){let{data:e,error:t}=await r.from("tarot_readings").select("*").eq("id",i).single();if(t){if("PGRST116"===t.code)return p.NextResponse.json({success:!1,error:"Reading not found",code:"READING_NOT_FOUND"},{status:404});return console.error("Database fetch error:",t),p.NextResponse.json({success:!1,error:"Failed to fetch reading",code:"FETCH_ERROR"},{status:500})}let s=R(e);return p.NextResponse.json({success:!0,reading:s})}let N=r.from("tarot_readings").select("*",{count:"exact"});if(a&&(N=N.eq("user_id",a)),u&&["single","three-card","celtic-cross"].includes(u)&&(N=N.eq("spread_type",u)),null!==I&&(N=N.eq("metadata->>isPublic",("true"===I).toString())),n){let e=new Date(n),t=new Date(n);t.setDate(t.getDate()+1),N=N.gte("created_at",e.toISOString()).lt("created_at",t.toISOString())}else if(c&&(N=N.gte("created_at",new Date(c).toISOString())),d){let e=new Date(d);e.setDate(e.getDate()+1),N=N.lt("created_at",e.toISOString())}if(g)for(let e of g.split(",").map(e=>e.trim()))N=N.contains("cards_drawn->tags",[e]);let _=["created_at","spread_type"].includes(f)?f:"created_at";N=N.order(_,{ascending:"asc"===h});let q=(x-1)*m;N=N.range(q,q+m-1);let{data:w,error:D,count:E}=await N;if(D)return console.error("Database fetch error:",D),p.NextResponse.json({success:!1,error:"Failed to fetch readings",code:"FETCH_ERROR",details:D.message},{status:500});let O=w?.map(R)||[],S=E||0,y=q+m<S;return l.info("tarot_readings_fetched",a||void 0,{page:x,limit:m,spreadType:u,date:n,tags:g?g.split(","):void 0,totalReadings:O.length,queryId:i},`Fetched ${O.length} readings.`),p.NextResponse.json({success:!0,readings:O,pagination:{page:x,limit:m,total:S,hasMore:y}},{headers:{"X-Total-Count":S.toString(),"X-Page":x.toString(),"X-Has-More":y.toString()}})}catch(e){return console.error("Get reading error:",e),p.NextResponse.json({success:!1,error:"Internal server error",code:"INTERNAL_ERROR",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}function R(e){let t=e.cards_drawn||{};return{id:e.id,userId:e.user_id,spreadType:e.spread_type,cards:t.cards||[],positions:t.positions||[],interpretation:e.interpretation_text,question:t.question,notes:e.metadata?.notes,cosmicInfluence:e.cosmic_influence,isPublic:e.metadata?.isPublic||!1,tags:t.tags||[],createdAt:e.created_at,drawId:t.drawId}}async function x(e){try{let{searchParams:t}=new URL(e.url),r=t.get("id"),s=t.get("userId");if(!r||!s)return p.NextResponse.json({success:!1,error:"Reading ID and User ID are required",code:"MISSING_PARAMETERS"},{status:400});let{data:a,error:i}=await u.from("tarot_readings").delete().eq("id",r).eq("user_id",s).select("id");if(i)return console.error("Database delete error:",i),p.NextResponse.json({success:!1,error:"Failed to delete reading",code:"DELETE_ERROR"},{status:500});if(!a||0===a.length)return p.NextResponse.json({success:!1,error:"Reading not found or access denied",code:"NOT_FOUND_OR_FORBIDDEN"},{status:404});return l.info("tarot_reading_deleted",s,{readingId:r},`Reading ${r} deleted by user ${s}.`),p.NextResponse.json({success:!0,deletedId:r,deletedAt:new Date().toISOString()})}catch(e){return console.error("Delete reading error:",e),p.NextResponse.json({success:!1,error:"Internal server error",code:"INTERNAL_ERROR"},{status:500})}}let m=new a.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/tarot/get-reading/route",pathname:"/api/tarot/get-reading",filename:"route",bundlePath:"app/api/tarot/get-reading/route"},resolvedPagePath:"/Users/kfitz/mystic-arcana-v1000/src/app/api/tarot/get-reading/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:f,workUnitAsyncStorage:h,serverHooks:N}=m;function _(){return(0,n.patchFetch)({workAsyncStorage:f,workUnitAsyncStorage:h})}},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},86481:(e,t,r)=>{"use strict";r.d(t,{A:()=>a});class s{constructor(e){this.serviceName=e}log(e,t,r,s,a,i){let n={timestamp:new Date().toISOString(),level:e,service:this.serviceName,action:t,userId:r,metadata:s,message:a};i&&(n.error={name:i.name,message:i.message,stack:i.stack}),console.log(JSON.stringify(n))}debug(e,t,r,s){this.log("DEBUG",e,t,r,s)}info(e,t,r,s){this.log("INFO",e,t,r,s)}warn(e,t,r,s){this.log("WARN",e,t,r,s)}error(e,t,r,s,a){this.log("ERROR",e,t,r,a,s)}}let a=s},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[4447,580,6437],()=>r(50160));module.exports=s})();