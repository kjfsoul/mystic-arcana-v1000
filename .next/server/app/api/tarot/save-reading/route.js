(()=>{var e={};e.id=1165,e.ids=[1165],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},39727:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},80209:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>h,routeModule:()=>l,serverHooks:()=>v,workAsyncStorage:()=>_,workUnitAsyncStorage:()=>R});var s={};r.r(s),r.d(s,{GET:()=>g,POST:()=>p});var a=r(96559),i=r(48088),o=r(37719),n=r(86481),c=r(66437),d=r(32190);let u=new n.A("TarotSaveReadingAPI");async function p(e){let t;try{if(!(t=await e.json()))return d.NextResponse.json({success:!1,error:"Invalid request body",code:"INVALID_BODY"},{status:400});let{spreadType:r,cards:s,interpretation:a}=t,i=e.headers.get("authorization");if(!i||!i.startsWith("Bearer "))return d.NextResponse.json({success:!1,error:"Authentication required",code:"UNAUTHENTICATED"},{status:401});let o=i.split(" ")[1],n=(0,c.UU)("https://pqfsbxcbsxuyfgqrxdob.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxZnNieGNic3h1eWZncXJ4ZG9iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NDk4MDAsImV4cCI6MjA2MzUyNTgwMH0.RH_VQLoTOdAauUciYWC39Wto1ZmK28gWjQ9eWJ0FEGU",{global:{headers:{Authorization:`Bearer ${o}`}}}),{data:{user:p},error:g}=await n.auth.getUser(o);if(g)return u.warn("tarot_save_reading_auth_error",void 0,{error:g.message},"Authentication error while saving reading."),d.NextResponse.json({success:!1,error:"Authentication failed",code:"AUTH_ERROR"},{status:401});if(!p)return u.warn("tarot_save_reading_unauthenticated",void 0,{},"Attempted to save reading without authentication."),d.NextResponse.json({success:!1,error:"Authentication required",code:"UNAUTHENTICATED"},{status:401});let l=p.id;if(!r||!["single","three-card","celtic-cross"].includes(r))return d.NextResponse.json({success:!1,error:"Valid spread type is required (single, three-card, celtic-cross)",code:"INVALID_SPREAD_TYPE"},{status:400});if(!s||!Array.isArray(s)||0===s.length)return d.NextResponse.json({success:!1,error:"Cards array is required and cannot be empty",code:"INVALID_CARDS"},{status:400});if(!a||0===a.trim().length)return d.NextResponse.json({success:!1,error:"Interpretation is required",code:"MISSING_INTERPRETATION"},{status:400});let _={single:1,"three-card":3,"celtic-cross":10};if(s.length!==_[r])return d.NextResponse.json({success:!1,error:`${r} spread requires exactly ${_[r]} cards, got ${s.length}`,code:"CARD_COUNT_MISMATCH"},{status:400});let R={user_id:l,spread_type:r,cards_drawn:{cards:s.map(e=>({id:e.id,name:e.name,position:e.position,isReversed:e.isReversed,meaning:e.meaning,frontImage:e.frontImage,backImage:e.backImage})),positions:s.map(e=>e.position),drawId:t.drawId,question:t.question,tags:t.tags||[]},interpretation_text:a,cosmic_influence:t.cosmicInfluence||null,metadata:{isPublic:t.isPublic||!1,notes:t.notes,savedAt:new Date().toISOString(),version:"1.0"}},v=Date.now(),{data:h,error:I}=await n.from("tarot_readings").insert([R]).select("id, created_at").single();if(I)return console.error("Database save error:",I),d.NextResponse.json({success:!1,error:"Failed to save reading",code:"SAVE_ERROR",details:I.message},{status:500});let x=Date.now()-v,f={success:!0,readingId:h.id,savedAt:h.created_at};return u.info("tarot_reading_saved",l||void 0,{readingId:h.id,spreadType:r,cardCount:s.length,question:t.question,tags:t.tags,saveTime:x},`Tarot reading (ID: ${h.id}) saved for user ${l}.`),d.NextResponse.json(f,{headers:{"X-Save-Time":x.toString(),"X-Reading-ID":h.id},status:201})}catch(e){return u.error("tarot_save_reading_error",t?.userId,{spreadType:t?.spreadType,cardsCount:t?.cards?.length},e,"Failed to save tarot reading."),d.NextResponse.json({success:!1,error:"Internal server error",code:"INTERNAL_ERROR",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}async function g(e){let{searchParams:t}=new URL(e.url),r=t.get("userId");try{if(!r)return u.warn("tarot_get_save_stats_missing_user_id",void 0,{},"Attempted to get save statistics without a user ID."),d.NextResponse.json({success:!1,error:"User ID is required",code:"MISSING_USER_ID"},{status:400});let e="https://pqfsbxcbsxuyfgqrxdob.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)return u.error("tarot_get_save_stats_config_error",r||void 0,{},void 0,"Database configuration error for save statistics."),d.NextResponse.json({success:!1,error:"Database configuration error",code:"CONFIG_ERROR"},{status:500});let s=(0,c.UU)(e,t,{auth:{autoRefreshToken:!1,persistSession:!1}}),{data:a,error:i}=await s.from("tarot_readings").select("id, spread_type, created_at").eq("user_id",r).order("created_at",{ascending:!1});if(i)return u.error("tarot_get_save_stats_fetch_error",r||void 0,{},i,"Failed to fetch reading statistics from database."),d.NextResponse.json({success:!1,error:"Failed to fetch reading statistics",code:"FETCH_ERROR"},{status:500});let o={totalReadings:a?.length||0,readingsByType:{single:a?.filter(e=>"single"===e.spread_type).length||0,"three-card":a?.filter(e=>"three-card"===e.spread_type).length||0,"celtic-cross":a?.filter(e=>"celtic-cross"===e.spread_type).length||0},lastReading:a?.[0]?.created_at||null,limits:{maxReadingsPerDay:50,maxReadingsPerMonth:500,storageRetention:"1 year"}};return u.info("tarot_get_save_stats_success",r||void 0,{totalReadings:o.totalReadings,readingsByType:o.readingsByType},"Successfully retrieved tarot save statistics."),d.NextResponse.json({success:!0,userId:r,statistics:o})}catch(e){return u.error("tarot_get_save_stats_internal_error",r||void 0,{},e,"Internal server error while getting tarot save statistics."),d.NextResponse.json({success:!1,error:"Internal server error",code:"INTERNAL_ERROR"},{status:500})}}let l=new a.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/tarot/save-reading/route",pathname:"/api/tarot/save-reading",filename:"route",bundlePath:"app/api/tarot/save-reading/route"},resolvedPagePath:"/Users/kfitz/mystic-arcana-v1000/src/app/api/tarot/save-reading/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:_,workUnitAsyncStorage:R,serverHooks:v}=l;function h(){return(0,o.patchFetch)({workAsyncStorage:_,workUnitAsyncStorage:R})}},81630:e=>{"use strict";e.exports=require("http")},86481:(e,t,r)=>{"use strict";r.d(t,{A:()=>a});class s{constructor(e){this.serviceName=e}log(e,t,r,s,a,i){let o={timestamp:new Date().toISOString(),level:e,service:this.serviceName,action:t,userId:r,metadata:s,message:a};i&&(o.error={name:i.name,message:i.message,stack:i.stack}),console.log(JSON.stringify(o))}debug(e,t,r,s){this.log("DEBUG",e,t,r,s)}info(e,t,r,s){this.log("INFO",e,t,r,s)}warn(e,t,r,s){this.log("WARN",e,t,r,s)}error(e,t,r,s,a){this.log("ERROR",e,t,r,a,s)}}let a=s},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[4447,580,6437],()=>r(80209));module.exports=s})();